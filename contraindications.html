<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>CDSS - Contraindication Assessment</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
        }
        h1 {
            text-align: center;
        }
        p.instructions {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
        }
        p.subnote {
            text-align: center;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 20px;
        }
        .field {
            background: white;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        label {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }
        .med-info {
            font-weight: normal;
            font-size: 0.9em;
            color: #333;
            margin-left: 20px;
            margin-top: -5px;
            margin-bottom: 5px;
        }
        button {
            padding: 10px 20px;
            background: #007BFF;
            border: none;
            color: white;
            font-size: 1em;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-top: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        #result {
            margin-top: 20px;
            padding: 10px;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 5px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>
<body>

<h1>Contraindication Assessment</h1>
<p class="instructions">Please tick all contraindications present for this patient. Multiple selections allowed.</p>
<p class="subnote">Note: Some contraindications (e.g., renal failure) are assessed automatically from previous patient data.</p>

<form id="cdssForm" onsubmit="return false;">
    <div class="field">
        <label><input type="checkbox" id="ci_active_bleeding" /> Active bleeding</label>
    </div>
    <div class="field">
        <label><input type="checkbox" id="ci_endocarditis" /> Acute bacterial endocarditis</label>
    </div>
    <div class="field">
        <label><input type="checkbox" id="ci_gi_ulcus_active" /> Active gastrointestinal ulcer</label>
    </div>
    <div class="field">
        <label><input type="checkbox" id="ci_liver_failure_child_c_or_coagulopathy" /> Liver failure CHILD C or coagulopathy</label>
    </div>
    <div class="field" id="pregnantField" style="display:none;">
        <label><input type="checkbox" id="ci_pregnant_or_breastfeeding" /> Pregnant or breastfeeding</label>
    </div>
    <div class="field">
        <label><input type="checkbox" id="ci_drugs" /> One or more interacting medications present</label>
        <div class="med-info">
            Includes: rifampicin, carbamazepin, phenobarbital, phenytoin, St. John's wort, HIV-Protease inhibitor, azol-antimycotic, clarithromycin
        </div>
    </div>

    <button type="button" onclick="checkContraindications()">Check Contraindications</button>
    <button type="button" onclick="showJSON()">Show JSON Output</button>
</form>

<div id="result"></div>

<script>
    // Example derived data from prior forms or calculations
    const derived_ci_age = false; // true if patient <18 years old
    const ci_renal_failure = false; // true if GFR < 15, determined previously

    // Simulated variable â€” set dynamically or fetch from patient record
    const sex = 'F'; // 'F' for female, 'M' for male, etc.

    // Show or hide pregnant/breastfeeding checkbox based on sex
    window.onload = () => {
        const pregnantField = document.getElementById('pregnantField');
        if (sex === 'F') {
            pregnantField.style.display = 'block';
        } else {
            pregnantField.style.display = 'none';
            // Uncheck if hidden, just in case
            document.getElementById('ci_pregnant_or_breastfeeding').checked = false;
        }
    };

    function checkContraindications() {
        const contraindications = [];

        // Derived from previous data
        if (derived_ci_age) contraindications.push("Patient is under 18 years old");
        if (ci_renal_failure) contraindications.push("Renal failure (GFR < 15)");

        // From current form (alphabetically, interacting meds last)
        if (document.getElementById('ci_active_bleeding').checked) contraindications.push("Active bleeding");
        if (document.getElementById('ci_endocarditis').checked) contraindications.push("Acute bacterial endocarditis");
        if (document.getElementById('ci_gi_ulcus_active').checked) contraindications.push("Active gastrointestinal ulcer");
        if (document.getElementById('ci_liver_failure_child_c_or_coagulopathy').checked) contraindications.push("Liver failure CHILD C or liver disease with coagulopathy");
        if (sex === 'F' && document.getElementById('ci_pregnant_or_breastfeeding').checked) contraindications.push("Pregnant or breastfeeding");
        if (document.getElementById('ci_drugs').checked) contraindications.push("Interacting medication present");

        const derived_absolute_contraindication = contraindications.length > 0;

        const resultBox = document.getElementById('result');
        if (derived_absolute_contraindication) {
            resultBox.innerHTML = `<strong>Absolute contraindications found:</strong><ul>` +
                contraindications.map(c => `<li>${c}</li>`).join('') +
                `</ul><p style="color:red"><strong>Patient is NOT eligible for DOAC therapy.</strong></p>`;
        } else {
            resultBox.innerHTML = "<strong>No contraindications detected. Patient is eligible for DOAC therapy.</strong>";
        }
    }

    function getFormDataAsJSON() {
        return {
            ci_active_bleeding: document.getElementById('ci_active_bleeding').checked,
            ci_endocarditis: document.getElementById('ci_endocarditis').checked,
            ci_gi_ulcus_active: document.getElementById('ci_gi_ulcus_active').checked,
            ci_liver_failure_child_c_or_coagulopathy: document.getElementById('ci_liver_failure_child_c_or_coagulopathy').checked,
            ci_pregnant_or_breastfeeding: sex === 'F' ? document.getElementById('ci_pregnant_or_breastfeeding').checked : false,
            ci_drugs: document.getElementById('ci_drugs').checked,
            derived_ci_age: derived_ci_age,
            ci_renal_failure: ci_renal_failure,
            sex: sex
        };
    }

    function showJSON() {
        const data = getFormDataAsJSON();
        const jsonString = JSON.stringify(data, null, 2);
        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = "<pre>" + jsonString + "</pre>";
    }
</script>

</body>
</html>
